<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Chapter&#160;11.&#160;Connection Management</title>
<link rel="stylesheet" href="boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="index.html" title="QUINCE: QUeries IN C++ Expressions">
<link rel="up" href="depth.html" title="Part&#160;II.&#160;The Quince API in Depth">
<link rel="prev" href="transactions.html" title="Chapter&#160;10.&#160;Transactions">
<link rel="next" href="the_back_end_libraries.html" title="Part&#160;III.&#160;The Back-End Libraries">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="transactions.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="depth.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="the_back_end_libraries.html"><img src="images/next.png" alt="Next"></a>
</div>
<div class="chapter">
<div class="titlepage"><div><div><h2 class="title">
<a name="connection_management"></a>Chapter&#160;11.&#160;Connection Management</h2></div></div></div>
<p>
        
      </p>
<p>
        There are no public quince functions to open or close connections to the
        database. Quince does that automatically.
      </p>
<p>
        This chapter describes quince's policies for connection management, partly
        in case you're curious, partly in case you want to know whether it's doing
        something inefficient, and partly because, if you're using a remote PostgreSQL
        server over an unreliable network (aka any network), you may need to write
        code that responds when things break.
      </p>
<h3>
<a name="connection_management.h0"></a>
        <span class="phrase"><a name="connection_management.laws"></a></span><a class="link" href="connection_management.html#connection_management.laws">Laws</a>
      </h3>
<p>
        We begin with five laws that quince always upholds:
      </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
            A thread only uses a connection if it <span class="emphasis"><em>holds</em></span> that
            connection.
          </li>
<li class="listitem">
            No thread holds more than one connection to the same database at the
            same time.
          </li>
<li class="listitem">
            No two threads hold the same connection at the same time.
          </li>
<li class="listitem">
            When a thread uses a connection to open a transaction, it holds that
            connection until the transaction is finished.
          </li>
<li class="listitem">
            When a thread uses a connection to <code class="computeroutput"><span class="identifier">begin</span><span class="special">()</span></code> a query, it holds that connection as
            long as it holds the iterator that <code class="computeroutput"><span class="identifier">begin</span><span class="special">()</span></code> returned.
          </li>
</ol></div>
<p>
        Taken together, these laws are a bit like saying <span class="quote">&#8220;<span class="quote">one connection per
        database per thread</span>&#8221;</span>, but not quite.
      </p>
<p>
        Here's the difference. Suppose a certain thread is communicating with database
        <span class="emphasis"><em>D</em></span> via connection <span class="emphasis"><em>C</em></span>. As long as
        it holds at least one transaction and/or at least iterator pertaining to
        <span class="emphasis"><em>D</em></span>, it will keep using connection <span class="emphasis"><em>C</em></span>.
        But if it ever <span class="quote">&#8220;<span class="quote">lets go</span>&#8221;</span> completely, i.e. if it reaches a stage
        where it has no transactions or iterators for <span class="emphasis"><em>D</em></span>, then,
        under these laws, there is no guarantee that it will use <span class="emphasis"><em>C</em></span>
        for any subsequent communication with <span class="emphasis"><em>D</em></span>.
      </p>
<h3>
<a name="connection_management.h1"></a>
        <span class="phrase"><a name="connection_management.pooling"></a></span><a class="link" href="connection_management.html#connection_management.pooling">Pooling</a>
      </h3>
<p>
        When a thread <span class="quote">&#8220;<span class="quote">lets go</span>&#8221;</span> in this sense, it no longer holds the
        connection, but quince keeps the connection open and saves it in a pool of
        open connections. The pool is specific to one database but not specific to
        any thread. Whenever a thread needs a connection, it takes one from the appropriate
        database-specific pool, if it can. It only establishes a new connection if
        the pool is dry.
      </p>
<p>
        So, in a single-threaded application, there can only be one connection to
        a given database. It is established for the first access, and over time it
        may dip in and out of the pool, but (apart from breakages) there will never
        be need of a second one.
      </p>
<p>
        In a multi-threaded application, if two or more threads have communicated
        with a database, and have since let go, and are now starting to communicate
        with it again, then each thread might get the connection it used before,
        or it might get a connection that another thread used before -- it doesn't
        matter which.
      </p>
<a name="breakage"></a><h3>
<a name="connection_management.h2"></a>
        <span class="phrase"><a name="connection_management.breakage_postgresql_only"></a></span><a class="link" href="connection_management.html#connection_management.breakage_postgresql_only">Breakage
        (PostgreSQL only)</a>
      </h3>
<p>
        When you use PostgreSQL, the DBMS can be running on a remote host, and the
        physical link can fail, or any number of other factors can cause established
        connections to stop working. Then quince throws a <code class="computeroutput"><span class="identifier">broken_connection_exception</span></code>.
      </p>
<p>
        <code class="computeroutput"><span class="identifier">broken_connection_exception</span></code>
        should not be confused with <code class="computeroutput"><span class="identifier">failed_connection_exception</span></code>.
        The latter indicates that a connection could not be established; the former
        indicates that a connection that once was established has now stopped working.
        A <code class="computeroutput"><span class="identifier">failed_connection_exception</span></code>
        can be due to a broken network link etc., but it has many other possible
        causes, e.g. the database you want doesn't exist, or you're not authorized
        -- even on sqlite.
      </p>
<p>
        If you want to catch <code class="computeroutput"><span class="identifier">broken_connection_exception</span></code>,
        the <code class="computeroutput"><span class="keyword">catch</span></code> should be outside
        the scope of any <code class="computeroutput"><span class="identifier">transaction</span></code>
        or query iterator. Then the application can decide how to respond, e.g. retry
        immediately, or retry after a delay, or report an error and quit. (If it
        retries, then be prepared for <code class="computeroutput"><span class="identifier">failed_connection_exception</span></code>.)
      </p>
<p>
        Quince responds also, as follows:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
            The broken connection is closed, and not returned to the pool.
          </li>
<li class="listitem">
            Any pooled connections to the same database are closed and removed from
            the pool.
          </li>
<li class="listitem">
            Any connections to the same database that are currently held by the application
            (which can only mean: held by other threads) will never be returned to
            the pool. At the time when they would have been returned to the pool,
            they will be closed instead.
          </li>
</ul></div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2014 Michael Shepanski<p>
        Distributed under the Boost Software License, Version 1.0
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="transactions.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="depth.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="the_back_end_libraries.html"><img src="images/next.png" alt="Next"></a>
</div>
</body>
</html>
