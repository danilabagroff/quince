<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Chapter&#160;10.&#160;Transactions</title>
<link rel="stylesheet" href="boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="index.html" title="QUINCE: QUeries IN C++ Expressions">
<link rel="up" href="depth.html" title="Part&#160;II.&#160;The Quince API in Depth">
<link rel="prev" href="custom/deployment/table.html" title="... or to a Table">
<link rel="next" href="connection_management.html" title="Chapter&#160;11.&#160;Connection Management">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="custom/deployment/table.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="depth.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="connection_management.html"><img src="images/next.png" alt="Next"></a>
</div>
<div class="chapter">
<div class="titlepage"><div><div><h2 class="title">
<a name="transactions"></a>Chapter&#160;10.&#160;Transactions</h2></div></div></div>
<p>
        
      </p>
<p>
        Quince's <code class="computeroutput"><span class="identifier">transaction</span></code> class
        provides an <a href="http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization" target="_top">RAII</a>
        wrapper for SQL's <code class="literal">BEGIN</code>, <code class="literal">COMMIT</code> and
        <code class="literal">ROLLBACK</code> commands.
      </p>
<p>
        You can construct a <code class="computeroutput"><span class="identifier">transaction</span></code>
        object while another <code class="computeroutput"><span class="identifier">transaction</span></code>
        object, for the same database <a href="#ftn.transactions.f0" class="footnote" name="transactions.f0"><sup class="footnote">[19]</sup></a> , exists on the same thread. Then the newer <code class="computeroutput"><span class="identifier">transaction</span></code>
        is said to be <span class="emphasis"><em>nested</em></span>. Nested transactions (to any depth)
        wrap SQL's <code class="literal">SAVEPOINT</code>, <code class="literal">ROLLBACK TO</code>,
        and <code class="literal">RELEASE SAVEPOINT</code> commands.
      </p>
<p>
        Every DBMS offers a range of options about its synchronization behaviour
        (isolation level, <span class="quote">&#8220;<span class="quote">shared-cache locking</span>&#8221;</span>). To the extent that
        that control is available to quince applications, it is via the <a class="link" href="quince_postgresql.html#quince_postgresql.constructor" title="The quince_postgresql::database constructor">backend</a>
        <a class="link" href="quince_sqlite.html#quince_sqlite.constructor" title="The quince_sqlite::database constructor">libraries</a>, not via quince
        itself. Quince's <code class="computeroutput"><span class="identifier">transaction</span></code>
        class assumes that the synchronization behaviour has already been configured
        to your taste, or more accurately: it has no awareness of it. If the DBMS
        does the right thing, or the wrong thing, or is efficient, or inefficient,
        then that is what an application using the <code class="computeroutput"><span class="identifier">transaction</span></code>
        class will see.
      </p>
<h3>
<a name="transactions.h0"></a>
        <span class="phrase"><a name="transactions.starting_committing_and_rolling_"></a></span><a class="link" href="transactions.html#transactions.starting_committing_and_rolling_">Starting,
        committing, and rolling back a transaction</a>
      </h3>
<p>
        Code for a typical transaction looks like this:
      </p>
<pre class="programlisting"><span class="special">{</span>
    <span class="identifier">transaction</span> <span class="identifier">txn</span><span class="special">(</span><span class="identifier">db</span><span class="special">);</span>

    <span class="comment">// ... statements to be executed in one transaction ...</span>

    <span class="identifier">txn</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<p>
        If the body runs all the way through, then <code class="computeroutput"><span class="identifier">txn</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span></code> will be executed and the transaction will
        be committed. If <code class="computeroutput"><span class="identifier">txn</span></code> falls
        out of scope without being committed, then the transaction will be rolled
        back. So if you are part way through a transaction and you want it rolled
        back, throw an exception that will not be caught within the <code class="computeroutput"><span class="identifier">transaction</span></code>'s scope.
      </p>
<p>
        Caution: the transaction will be rolled back if you bypass the <code class="computeroutput"><span class="identifier">commit</span><span class="special">()</span></code>
        by <span class="emphasis"><em>any</em></span> means, including <code class="computeroutput"><span class="keyword">break</span></code>,
        <code class="computeroutput"><span class="keyword">continue</span></code> or <code class="computeroutput"><span class="keyword">return</span></code>.
        That can lead to bugs, e.g. you've finished the work you wanted to do, you
        think you're <code class="computeroutput"><span class="keyword">return</span></code>ing in triumph,
        and then it all gets rolled back as if it were failure. To avoid confusion,
        I suggest that you never use <code class="computeroutput"><span class="keyword">break</span></code>,
        <code class="computeroutput"><span class="keyword">continue</span></code> or <code class="computeroutput"><span class="keyword">return</span></code>
        in a way that would exit a <code class="computeroutput"><span class="identifier">transaction</span></code>'s
        scope.
      </p>
<p>
        <code class="computeroutput"><span class="identifier">commit</span><span class="special">()</span></code>
        is only allowed on the <code class="computeroutput"><span class="identifier">transaction</span></code>
        that is currently the innermost one for its database. If you try to commit
        an outer <code class="computeroutput"><span class="identifier">transaction</span></code> (not
        necessarily the outermost) while an inner <code class="computeroutput"><span class="identifier">transaction</span></code>
        exists, or commit a <code class="computeroutput"><span class="identifier">transaction</span></code>
        that was created on another thread, then <code class="computeroutput"><span class="identifier">commit</span><span class="special">()</span></code> throws a <code class="computeroutput"><span class="identifier">non_current_txn_exception</span></code>.
      </p>
<a name="deadlock"></a><h3>
<a name="transactions.h1"></a>
        <span class="phrase"><a name="transactions.deadlock"></a></span><a class="link" href="transactions.html#transactions.deadlock">Deadlock</a>
      </h3>
<p>
        When an operation would result in deadlock, the DBMS reports it to quince,
        and quince throws <code class="computeroutput"><span class="identifier">deadlock_exception</span></code>.
        Usually that is not an error, but it is a sign that the transaction needs
        to be rolled back and tried again. Here is some code you can use:
      </p>
<pre class="programlisting"><span class="keyword">for</span> <span class="special">(;;)</span> <span class="special">{</span>
    <span class="keyword">try</span> <span class="special">{</span>
        <span class="identifier">transaction</span> <span class="identifier">txn</span><span class="special">(</span><span class="identifier">db</span><span class="special">);</span>

        <span class="comment">// statements to be executed in one transaction ...</span>

        <span class="identifier">txn</span><span class="special">.</span><span class="identifier">commit</span><span class="special">();</span>
    <span class="special">}</span>
    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">deadlock_exception</span> <span class="special">&amp;)</span> <span class="special">{</span>
        <span class="keyword">continue</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">break</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<h3>
<a name="transactions.h2"></a>
        <span class="phrase"><a name="transactions.implementation"></a></span><a class="link" href="transactions.html#transactions.implementation">Implementation</a>
      </h3>
<p>
        Quince <code class="computeroutput"><span class="identifier">transaction</span></code>s pass
        on the subtle behaviour of the SQL constructs that they wrap, so you might
        need to know what is going on at the SQL level. The following table provides
        translations.
      </p>
<div class="informaltable"><table class="table">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                <p>
                  Quince
                </p>
              </th>
<th>
                <p>
                  SQL for an outermost transaction
                </p>
              </th>
<th>
                <p>
                  SQL for a nested transaction
                </p>
              </th>
</tr></thead>
<tbody>
<tr>
<td>
                <p>
                  <code class="computeroutput"><span class="identifier">transaction</span></code> <em class="replaceable"><code>txn</code></em>
                  constructed
                </p>
              </td>
<td>
                <p>
                  <code class="literal">BEGIN</code>
                </p>
              </td>
<td>
                <p>
                  <code class="literal">SAVEPOINT save_point_</code><em class="replaceable"><code>nnn</code></em>
                </p>
              </td>
</tr>
<tr>
<td>
                <p>
                  <em class="replaceable"><code>txn</code></em><code class="computeroutput"><span class="special">.</span><span class="identifier">commit</span><span class="special">()</span></code>
                </p>
              </td>
<td>
                <p>
                  <code class="literal">COMMIT</code>
                </p>
              </td>
<td>
              </td>
</tr>
<tr>
<td>
                <p>
                  <em class="replaceable"><code>txn</code></em> destructed without having been committed
                </p>
              </td>
<td>
                <p>
                  <code class="literal">ROLLBACK</code>
                </p>
              </td>
<td>
                <p>
                  <code class="literal">ROLLBACK TO save_point_</code><em class="replaceable"><code>nnn</code></em>
                </p>
              </td>
</tr>
<tr>
<td>
                <p>
                  <em class="replaceable"><code>txn</code></em> destructed, whether committed or
                  not
                </p>
              </td>
<td>
              </td>
<td>
                <p>
                  <code class="literal">RELEASE SAVEPOINT save_point_</code><em class="replaceable"><code>nnn</code></em>
                </p>
              </td>
</tr>
</tbody>
</table></div>
<p>
        (<em class="replaceable"><code>nnn</code></em> stands for a number that quince allocates,
        to identify each nested transaction uniquely within an outermost transaction.)
      </p>
<div class="footnotes">
<br><hr style="width:100; text-align:left;margin-left: 0">
<div id="ftn.transactions.f0" class="footnote"><p><a href="#transactions.f0" class="para"><sup class="para">[19] </sup></a>
          Transactions for different databases are unrelated to each other, and do
          not count as nested within each other.
        </p></div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2014 Michael Shepanski<p>
        Distributed under the Boost Software License, Version 1.0
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="custom/deployment/table.html"><img src="images/prev.png" alt="Prev"></a><a accesskey="u" href="depth.html"><img src="images/up.png" alt="Up"></a><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"></a><a accesskey="n" href="connection_management.html"><img src="images/next.png" alt="Next"></a>
</div>
</body>
</html>
